<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Humidifier Timer</title>
<style>
body{font-family:system-ui;margin:24px}
button,input{font-size:16px}
.card{border:1px solid #ccc;border-radius:12px;padding:16px;max-width:420px}
.row{margin:12px 0}
</style>
</head>
<body>

<h2>Humidifier Timer</h2>
<div class="card">
  <div class="row">
    <button id="connect">Connect</button>
    <span id="status">Idle</span>
  </div>

  <div class="row">
    Enabled <input type="checkbox" id="en">
  </div>

  <div class="row">
    OFF (ms): <span id="offv"></span><br>
    <input type="range" id="off" min="500" max="60000" step="500">
  </div>

  <div class="row">
    ON (ms): <span id="onv"></span><br>
    <input type="range" id="on" min="200" max="60000" step="200">
  </div>

  <div class="row">
    <button id="apply">Apply</button>
    <span id="applyStatus"></span>
  </div>
</div>

<script>
if (!navigator.bluetooth) {
  document.getElementById("status").textContent =
    "Web Bluetooth not available. Use Chrome over HTTPS.";
}

const SVC="6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const ON ="6e400002-b5a3-f393-e0a9-e50e24dcca9e";
const OFF="6e400003-b5a3-f393-e0a9-e50e24dcca9e";
const EN ="6e400004-b5a3-f393-e0a9-e50e24dcca9e";

let chOn,chOff,chEn;

const $=id=>document.getElementById(id);
const u32=v=>new Uint8Array([v&255,v>>8&255,v>>16&255,v>>24&255]);
const r32=b=>b[0]|(b[1]<<8)|(b[2]<<16)|(b[3]<<24);

function upd(){
  $("offv").textContent=$("off").value;
  $("onv").textContent=$("on").value;
}
$("off").oninput=upd;
$("on").oninput=upd;

$("connect").onclick=async()=>{
  try{
    $("status").textContent="Connecting…";
    const dev=await navigator.bluetooth.requestDevice({filters:[{services:[SVC]}]});
    const srv=await (await dev.gatt.connect()).getPrimaryService(SVC);
    chOn =await srv.getCharacteristic(ON);
    chOff=await srv.getCharacteristic(OFF);
    chEn =await srv.getCharacteristic(EN);

    $("on").value = r32(new Uint8Array(await (await chOn.readValue()).buffer));
    $("off").value= r32(new Uint8Array(await (await chOff.readValue()).buffer));
    $("en").checked=(await chEn.readValue()).getUint8(0);
    upd();

    $("status").textContent="Connected";
  }catch(e){$("status").textContent=e.message;}
};

$("apply").onclick=async()=>{
  try{
    $("applyStatus").textContent="Applying…";
    await chOn.writeValueWithoutResponse(u32(+$("on").value));
    await chOff.writeValueWithoutResponse(u32(+$("off").value));
    await chEn.writeValueWithoutResponse(new Uint8Array([$("en").checked?1:0]));

    const on=r32(new Uint8Array(await (await chOn.readValue()).buffer));
    const off=r32(new Uint8Array(await (await chOff.readValue()).buffer));
    $("applyStatus").textContent=`Applied (ON ${on} / OFF ${off})`;
  }catch(e){$("applyStatus").textContent=e.message;}
};
upd();
</script>
</body>
</html>
